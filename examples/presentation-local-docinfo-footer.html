<script>
  'use strict'

  async function makeFetchRequest(url, method, headers, body) {
    try {
      const response = await fetch(url, {
        method: method,
        headers: headers,
        body: body
      });
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json(); // Assumes the server returns JSON
    } catch (error) {
      console.error(`Fetch operation for ${method} failed:`, error);
      throw error;
    }
  }

  function setUpIframe(iframeElement, question, concatenatedAnswerTexts) {
    const answers = concatenatedAnswerTexts.split(';').map(text => ({ text, votes: 0 }));
    const slide = { question, answers };
    makeFetchRequest('http://localhost:8080/slides', 'POST', { 'Content-Type': 'application/json' }, JSON.stringify(slide));
    iframeElement.innerHTML = `<iframe id="${question}" src="http://localhost:8080/client.html?question=${question}" width="800" height="300"></iframe>`;
  }

  function setUpIframes() {
    const iframeElements = document.querySelectorAll('.votingQuestion');
    iframeElements.forEach(iframeElement => {
      const [question, concatenatedAnswerTexts] = iframeElement.innerHTML.split(':');
      setUpIframe(iframeElement, question, concatenatedAnswerTexts);
    });
  }

  function putQuestionName(questionName) {
    makeFetchRequest('http://localhost:8080/current-question-name', 'PUT', { 'Content-Type': 'text/plain' }, questionName);
  }

  function setUpRevealListeners() {
    Reveal.on('ready', () => putQuestionName("No question"));
    Reveal.on('slidetransitionend', event => {
      const iframeIdElement = event.currentSlide.querySelector("iframe");
      putQuestionName(iframeIdElement ? iframeIdElement.id : "No question");
    });
  }

  (function() {
    setUpRevealListeners();
    setUpIframes();
  })();
</script>
