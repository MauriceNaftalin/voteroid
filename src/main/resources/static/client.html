<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/clientStompManager.js"></script>
    <script src="/d3manipulation.js"></script>
</head>
<body>
<svg id="svg"></svg>
<div id="buttonsDiv">
    <button class="answerButton">answerButton1</button>
    <button class="answerButton">answerButton2</button>
    <button class="answerButton">answerButton3</button>
</div>
<label style="width: 100px;" id="questionNameLabel">No question</label>
<!--https://stackoverflow.com/a/15069289-->
<script>
    connectStompClient();

    document.addEventListener('DOMContentLoaded', function() {
        var svgElement = document.getElementById("svg");
        const params = new URLSearchParams(window.location.search);
        if (params.size === 0) {
            // phone client
            setUpSvg(svgElement, window.innerWidth - 25, window.innerHeight - 75);
            getSlideAndProcess('current-slide', data => {
                showQuestionName(data.question);
                setButtonListenersAndLabels(data);
            })
        } else {
            // presentation iframe
            setUpSvg(svgElement, 250, 250);
            const question = params.get('question');
            showQuestionName(question);
            getSlideAndProcess(question, data => setButtonLabels(data.answers));
        }
    });

    function getSlideAndProcess(question, functionx) {
        fetch(`http://${window.location.host}/slides/${question}`, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(response => {if (!response.ok) throw new Error('Network error');return response.json();})
            .then(data => functionx(data))
            .catch(error => console.error('Fetch error:', error))
    }

    function setButtonLabels(answers) {
        const answerButtons = document.getElementsByClassName('answerButton');
        const answerTexts = answers.map(obj => obj.text);
        for (let answerIndex = 0; answerIndex < answerButtons.length; answerIndex++) {
            answerButtons[answerIndex].textContent = answerTexts[answerIndex];
            console.log(answerTexts);
        }
    }

    function setAnswerButtonListener(button, answerIndex) {
        button.addEventListener('click', function () {
                // 1-indexed, as serialization doesn't work for a payload of 0
                stompClient.publish({destination: "/app/vote", body: answerIndex + 1});
            }
        )
    }

    /* called at initialisation of the client, and when the slide changes */
    function setButtonListenersAndLabels(data) {
        const answerButtons = document.getElementsByClassName('answerButton');
        showQuestionName(data.question);
        if (data.question === "No question") {
            setSvgAndButtonVisibility('hidden')
        } else {
            setSvgAndButtonVisibility('visible')
            for (let answerIndex = 0; answerIndex < answerButtons.length; answerIndex++) {
                setAnswerButtonListener(answerButtons[answerIndex], answerIndex);
                setButtonLabels(data.answers);
                // d3 is 1-indexed
                setVoteCount({"answerIndex": answerIndex + 1, "voteCount": data.answers[answerIndex].votes});
            }
        }
    }

    function setSvgAndButtonVisibility(visibility) {
        document.getElementById('svg').style.visibility = visibility;
        document.getElementById('buttonsDiv').style.visibility = visibility;
    }
</script>
</body>
</html>
