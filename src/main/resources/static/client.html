<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/phoneClientStompManager.js"></script>
    <script src="/d3manipulation.js"></script>
</head>
<body>
<svg id="svg"></svg>
<div>
    <button class="answerButton">answerButton1</button>
    <button class="answerButton">answerButton2</button>
    <button class="answerButton">answerButton3</button>
</div>
<label style="width: 100px;" id="questionNameLabel">No question</label>
<!--https://stackoverflow.com/a/15069289-->
<script>
    connectStompClient();

    document.addEventListener('DOMContentLoaded', function() {
        var svgElement = document.getElementById("svg");
        const params = new URLSearchParams(window.location.search);
        if (params.size === 0) {
            var chartHeight = window.innerHeight - 75;
            var chartWidth = window.innerWidth - 20;
            svgElement.setAttribute("width", chartWidth);
            svgElement.setAttribute("height", chartHeight);
            setUpSvg(chartWidth, chartHeight);
            getCurrentQuestionAndSetButtonListeners();
        } else {
            showQuestionName(question);
            svgElement.setAttribute("width", 250);
            svgElement.setAttribute("height", 250);
            setUpSvg(250,250);
        }
    });

    function setAnswerButtonListener(button, answerIndex) {
        button.addEventListener('click', function () {
                // 1-indexed, as serialization doesn't work for a payload of 0
                stompClient.publish({destination: "/app/vote", body: answerIndex + 1});
            }
        )
    }

    /* called at initialisation of the client, and when the slide changes */
    function getCurrentQuestionAndSetButtonListeners() {
        fetch(`http://${window.location.host}/slides/current-slide`, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(response => {if (!response.ok) throw new Error('Network error');return response.json();})
            .then(data => {
                const answerButtons = document.getElementsByClassName('answerButton');
                showQuestionName(data.question);
                if (data.question === "No question") {
                    document.getElementById('svg').style.visibility = 'hidden';
                    for (let answerIndex = 0; answerIndex < answerButtons.length; answerIndex++) {
                        answerButtons[answerIndex].style.visibility = 'hidden';
                    }
                } else {
                    document.getElementById('svg').style.visibility = 'visible';
                    for (let answerIndex = 0; answerIndex < answerButtons.length; answerIndex++) {
                        setAnswerButtonListener(answerButtons[answerIndex], answerIndex);
                        answerButtons[answerIndex].textContent = data.answers[answerIndex].text;
                        // d3 is 1-indexed
                        setVoteCount({"answerIndex": answerIndex + 1, "voteCount": data.answers[answerIndex].votes});
                        answerButtons[answerIndex].style.visibility = 'visible';
                        const answerTexts = data.answers.map(obj => obj.text);
                        console.log(answerTexts);
                    }
                }
            })
            .catch(error => console.error('Fetch error:', error));
    }
</script>
</body>
</html>
