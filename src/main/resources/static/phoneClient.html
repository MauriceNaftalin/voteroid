<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phone Client</title>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script src="/phoneClientStompManager.js"></script>
</head>
<body>
<label style="width: 100px;" id="question">No question</label>
<br/>
<button class="answerButton">answerButton1</button>
<button class="answerButton">answerButton2</button>
<button class="answerButton">answerButton3</button>
<script>
    const answerButtons = document.getElementsByClassName('answerButton');
    var currentQuestion;

    connectStompClient();
    getCurrentQuestionAndSetButtonListeners();

    function setAnswerButtonListener(button, answerIndex) {
        button.addEventListener('click', function () {
            const requestOptions = {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
            };
            const voteUri = `http://localhost:8080/${currentQuestion}/answers/${answerIndex + 1}/vote`;
            fetch(voteUri, requestOptions)
                .then(response => {if (!response.ok) throw new Error('Network error');
                    console.log(`Vote registered: /${currentQuestion}/answers/${answerIndex + 1}/vote`);
                })
                .catch(error => {
                    console.error('Fetch operation error:', error);
                });
        })
    }

    /* called at initialisation of the client, and when the slide changes */
    function getCurrentQuestionAndSetButtonListeners() {
        fetch(`http://${window.location.host}/slides/current-slide`, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(response => {if (!response.ok) throw new Error('Network error');return response.json();})
            .then(data => {
                document.getElementById('question').textContent = data.question;
                if (data.question === "No question") {
                    for (let answerIndex = 0; answerIndex < answerButtons.length; answerIndex++) {
                        answerButtons[answerIndex].style.visibility = 'hidden';
                    }
                } else {
                    currentQuestion = data.question;
                    for (let answerIndex = 0; answerIndex < answerButtons.length; answerIndex++) {
                        setAnswerButtonListener(answerButtons[answerIndex], answerIndex);
                        answerButtons[answerIndex].textContent = data.answers[answerIndex].text;
                        answerButtons[answerIndex].style.visibility = 'visible';
                        const answerTexts = data.answers.map(obj => obj.text);
                        console.log(answerTexts);
                    }
                }
            })
            .catch(error => console.error('Fetch error:', error));
    }

</script>
</body>
</html>